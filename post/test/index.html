<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>test | Gridea</title>
<link rel="shortcut icon" href="https://21want28k.github.io//favicon.ico?v=1619342314239">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://21want28k.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="test | Gridea - Atom Feed" href="https://21want28k.github.io//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="环境描述

mysql：8.0.16

一条SQL语句如何执行
mysql&gt; select * from T where ID=10;


以上就是mysql 一条查询语句大概的执行流程图。
连接器


正常的使用mysql -u r..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://21want28k.github.io/">
  <img class="avatar" src="https://21want28k.github.io//images/avatar.png?v=1619342314239" alt="">
  </a>
  <h1 class="site-title">
    Gridea
  </h1>
  <p class="site-description">
    温故而知新
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              test
            </h2>
            <div class="post-info">
              <span>
                2021-04-25
              </span>
              <span>
                7 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h2 id="环境描述">环境描述</h2>
<ul>
<li>mysql：8.0.16</li>
</ul>
<h2 id="一条sql语句如何执行">一条SQL语句如何执行</h2>
<pre><code class="language-sql">mysql&gt; select * from T where ID=10;
</code></pre>
<figure data-type="image" tabindex="1"><img src="/Users/xiaoxin/Desktop/%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="image-20210422151521325" loading="lazy"></figure>
<p>以上就是mysql 一条查询语句大概的执行流程图。</p>
<h2 id="连接器">连接器</h2>
<ul>
<li>
<p>正常的使用<code>mysql -u root -p</code>的命令，这个时候不建议直接写上密码，比如<code>mysql -uroot -proot</code>  这样会暴露自己的密码。尤其是生产环境中。</p>
<ul>
<li>
<p>密码错误：ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: YES)</p>
</li>
<li>
<p>密码正确：会在权限表中读取你的权限，注：在连接过程中，如果在其他地方修改权限是不会影响到当前连接的，需要重新进行连接。</p>
<p>例子：</p>
<pre><code class="language-sql">conncection:root
CREATE USER 'user'@'localhost' IDENTIFIED BY 'user';  # 创建一个user用户，密码是user
CREATE TABLE user(
	user_id INT PRIMARY KEY auto_increment,
	name VARCHAR(10)
)
GRANT SELECT ON test.`user` TO 'user'@'localhost';

-----------------------------------------------------------------------------
conncection:user
mysql -uuser -p
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| test               |
+--------------------+
2 rows in set (0.00 sec)

mysql&gt; use test;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; select * from user;
+---------+------+
| user_id | name |
+---------+------+
|       1 | a    |
+---------+------+
1 row in set (0.00 sec)

mysql&gt; update user set name='b' where user_id = 1;
ERROR 1142 (42000): UPDATE command denied to user 'user'@'localhost' for table 'user'
####这个时候是没有update权限的，我们在connection：root中添加权限（此时connection：user不关闭）
-----------------------------------------------------------------------------

conncection:root
GRANT UPDATE ON test.`user` TO 'user'@'localhost';
-----------------------------------------------------------------------------

conncection:user
mysql&gt; update user set name='b' where user_id = 1;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0
####显然上面说的修改权限之后，需要重新开始连接才生效在8.0的版本中是不正确的。
</code></pre>
</li>
</ul>
</li>
<li>
<blockquote>
<p>连接完成后，如果你没有后续的动作，这个连接就处于空闲状态，你可以在 show processlist 命令中看到它。文本中这个图是 show processlist 的结果，其中的 Command 列显示为“Sleep”的这一行，就表示现在系统里面有一个空闲连接。</p>
</blockquote>
<p>Root:</p>
<p>![image-20210422171615530](/Users/xiaoxin/Desktop/show processlist.png)</p>
<p>User:</p>
<p>![image-20210422171745461](/Users/xiaoxin/Desktop/show processlist2.png)</p>
<p>很明显权限不一样，processlist下来的结果似乎也不一样啊。</p>
<blockquote>
<p>客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 wait_timeout 控制的，默认值是 8 小时。</p>
</blockquote>
<p>我们查看一下看看是不是：</p>
<pre><code class="language-mysql">SHOW VARIABLES LIKE '%wait_timeout%';
mysql&gt; SHOW VARIABLES LIKE '%wait_timeout%';
+--------------------------+----------+
| Variable_name            | Value    |
+--------------------------+----------+
| innodb_lock_wait_timeout | 50       |
| lock_wait_timeout        | 31536000 |
| mysqlx_wait_timeout      | 28800    |
| wait_timeout             | 28800    |   &lt;---就是8小时
+--------------------------+----------+
4 rows in set (0.00 sec)
</code></pre>
</li>
</ul>
<h2 id="query-cache-查询缓存">query cache 查询缓存</h2>
<p>关于查询缓存于8.0去除了，<a href="https://mysqlserverteam.com/mysql-8-0-retiring-support-for-the-query-cache/">mysql server team</a>中有如下解释：以下是翻译：</p>
<blockquote>
<p>mysql查询缓存是查询结果的缓存，它把即将到来的且以sel开头的查询和hash table进行比较，如何和之前执行的query查询结果一样，就算命中缓存，这也有一些限制。</p>
<ul>
<li>查询必须是每个字节都匹配（查询缓存避免了分析）</li>
<li>一些具有非特定的操作将导致查询不被缓存(including temporary tables, user variables, <code>RAND()</code>, <code>NOW()</code> and <code>UDFs</code>.)</li>
<li>查询缓存是不会服务过时的结果的，任何对基础表的修改都会引起缓存失效。</li>
<li>如果缓存应用于innodb会有很多限制。(to respect MVCC; as you have a transaction open, the ‘cache’ might not represent the data in your expected view.)</li>
</ul>
<p><em>The ideal scenario for the query cache tends to be largely read-only, where there are a number of very expensive queries which examine millions of rows only to return a few. A hypothetical example might be a complex query to build a list of values for a drop-down list that always appears on a webpage form. In a situation like this, the query cache can mask performance problems caused by missing indexes, which makes it helpful for novice users.</em>  意思就是说设计之初是用来查询哪些read-only的场景。</p>
<p>下面的意思就是说在client端做缓存会更好。</p>
</blockquote>
<h2 id="分析器">分析器</h2>
<blockquote>
<p>如果没有命中查询缓存，就要开始真正执行语句了。首先，MySQL 需要知道你要做什么， 因此需要对 SQL 语句做解析。</p>
<p>分析器先会做“词法分析”。你输入的是由多个字符串和空格组成的一条 SQL 语句， MySQL 需要识别出里面的字符串分别是什么，代表什么。</p>
<p>MySQL 从你输入的&quot;select&quot;这个关键字识别出来，这是一个查询语句。它也要把字符 串“T”识别成“表名 T”，把字符串“ID”识别成“列 ID”。</p>
<p>做完了这些识别以后，就要做“语法分析”。根据词法分析的结果，语法分析器会根据语法 规则，判断你输入的这个 SQL 语句是否满足 MySQL 语法。</p>
<p>如果你的语句不对，就会收到“You have an error in your SQL syntax”的错误提醒，比 如下面这个语句 select 少打了开头的字母“s”。</p>
</blockquote>
<p>理论意思，不用解释。</p>
<h2 id="优化器">优化器</h2>
<p>一言以蔽之优化语句。这边是简单论述。</p>
<h2 id="执行器">执行器</h2>
<blockquote>
<p>开始执行的时候，要先判断一下你对这个表 T 有没有执行查询的权限，如果没有，就会返 回没有权限的错误。</p>
<pre><code>如果有权限，就打开表继续执行。打开表的时候，执行器就会根据表的引擎定义，去使用这
个引擎提供的接口。
</code></pre>
<p>比如我们这个例子中的表 T 中，ID 字段没有索引，那么执行器的执行流程是这样的:</p>
<ol>
<li>
<p>调用 InnoDB 引擎接口取这个表的第一行，判断 ID 值是不是 10，如果不是则跳过，如 果是则将这行存在结果集中;</p>
</li>
<li>
<p>调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。</p>
</li>
<li>
<p>执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。</p>
</li>
</ol>
</blockquote>
<h2 id="总结">总结</h2>
<p>MySQL实战45讲中的第一讲，基础架构，部分，大概就是实验了一下conncetion部分，然后整体把握了下一条select 语句如何执行，里面内容不错，词法分析，语法分析等新概念。然后看了下，为什么查询缓存被删除弊端在哪，做个了结。</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E7%8E%AF%E5%A2%83%E6%8F%8F%E8%BF%B0">环境描述</a></li>
<li><a href="#%E4%B8%80%E6%9D%A1sql%E8%AF%AD%E5%8F%A5%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C">一条SQL语句如何执行</a></li>
<li><a href="#%E8%BF%9E%E6%8E%A5%E5%99%A8">连接器</a></li>
<li><a href="#query-cache-%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98">query cache 查询缓存</a></li>
<li><a href="#%E5%88%86%E6%9E%90%E5%99%A8">分析器</a></li>
<li><a href="#%E4%BC%98%E5%8C%96%E5%99%A8">优化器</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E5%99%A8">执行器</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://21want28k.github.io/post/hello-gridea/">
              <h3 class="post-title">
                Hello Gridea
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://21want28k.github.io//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
